# $URL$
# $Id$

#######################################################################
# Default compilation parameters. Normally don't edit these           #
#######################################################################

srcdir      ?= .

DEFINES     := -DHAVE_CONFIG_H
LDFLAGS     :=
INCLUDES    := -I. -I$(srcdir)
LIBS        :=
OBJS        :=
DEPDIR      := .deps

MODULES     :=
MODULE_DIRS :=

STANDALONE  :=
# This one will go away once all tools are converted
NO_MAIN     := -DEXPORT_MAIN


# Load the make rules generated by configure
-include config.mk

ifeq "$(HAVE_GCC)" "1"
	CXXFLAGS:= -Wall $(CXXFLAGS)
	# Turn off some annoying and not-so-useful warnings
	CXXFLAGS+= -Wno-long-long -Wno-multichar -Wno-unknown-pragmas -Wno-reorder
	# Enable even more warnings...
	CXXFLAGS+= -Wpointer-arith -Wcast-qual
	CXXFLAGS+= -Wshadow -Wnon-virtual-dtor -Wwrite-strings

	# Currently we disable this gcc flag, since it will also warn in cases,
	# where using GCC_PRINTF (means: __attribute__((format(printf, x, y))))
	# is not possible, thus it would fail compiliation with -Werror without
	# being helpful.
	#CXXFLAGS+= -Wmissing-format-attribute

ifneq "$(HAVE_CLANG)" "1"
	# enable checking of pointers returned by "new", but only when we do not
	# build with clang
	CXXFLAGS+= -fcheck-new
endif
endif

ifeq "$(HAVE_CLANG)" "1"
	CXXFLAGS+= -Wno-conversion -Wno-shorten-64-to-32 -Wno-sign-compare -Wno-four-char-constants
endif

#######################################################################
# Default commands - put the necessary replacements in config.mk      #
#######################################################################

CAT     ?= cat
CP      ?= cp
ECHO    ?= printf
INSTALL ?= install
MKDIR   ?= mkdir -p
RM      ?= rm -f
RM_REC  ?= $(RM) -r
ZIP     ?= zip -q

#######################################################################

include $(srcdir)/Makefile.common

# check if configure has been run or has been changed since last run
config.h config.mk: $(srcdir)/configure
ifeq "$(findstring config.mk,$(MAKEFILE_LIST))" "config.mk"
	@echo "Running $(srcdir)/configure with the last specified parameters"
	@sleep 2
	LDFLAGS="$(SAVED_LDFLAGS)" CXX="$(SAVED_CXX)" \
			CXXFLAGS="$(SAVED_CXXFLAGS)" CPPFLAGS="$(SAVED_CPPFLAGS)" \
			ASFLAGS="$(SAVED_ASFLAGS)" WINDRESFLAGS="$(SAVED_WINDRESFLAGS)" \
			$(srcdir)/configure $(SAVED_CONFIGFLAGS)
else
	$(error You need to run $(srcdir)/configure before you can run make. Check $(srcdir)/configure --help for a list of parameters)
endif

# Special target to create a win32 tools snapshot binary
WIN32PATH=build

# Special target to prepare data files for distribution / installer creation
win32data:
	mkdir -p $(srcdir)/$(WIN32PATH)
	cp $(srcdir)/COPYING          $(srcdir)/$(WIN32PATH)
	cp $(srcdir)/NEWS             $(srcdir)/$(WIN32PATH)
	cp $(srcdir)/README           $(srcdir)/$(WIN32PATH)
	unix2dos $(srcdir)/$(WIN32PATH)/*.*
	$(STRIP) decine.exe             -o $(srcdir)/$(WIN32PATH)/decine.exe
	$(STRIP) degob.exe              -o $(srcdir)/$(WIN32PATH)/degob.exe
	$(STRIP) dekyra.exe             -o $(srcdir)/$(WIN32PATH)/dekyra.exe
	$(STRIP) deriven.exe            -o $(srcdir)/$(WIN32PATH)/deriven.exe
	$(STRIP) descumm.exe            -o $(srcdir)/$(WIN32PATH)/descumm.exe
	$(STRIP) desword2.exe           -o $(srcdir)/$(WIN32PATH)/desword2.exe
	$(STRIP) extract_mohawk.exe     -o $(srcdir)/$(WIN32PATH)/extract_mohawk.exe
	$(STRIP) construct_mohawk.exe   -o $(srcdir)/$(WIN32PATH)/construct_mohawk.exe
	$(STRIP) gob_loadcalc.exe       -o $(srcdir)/$(WIN32PATH)/gob_loadcalc.exe
	$(STRIP) scummvm-tools.exe      -o $(srcdir)/$(WIN32PATH)/scummvm-tools.exe
	$(STRIP) scummvm-tools-cli.exe  -o $(srcdir)/$(WIN32PATH)/scummvm-tools-cli.exe

# Special target to create a win32 snapshot binary (for Inno Setup)
win32dist: all win32data 
	mkdir -p $(srcdir)/$(WIN32PATH)/tools
	mv $(srcdir)/$(WIN32PATH)/*.* $(srcdir)/$(WIN32PATH)/tools/
	cp $(srcdir)/*.bat $(srcdir)/$(WIN32PATH)/tools
	mkdir -p $(srcdir)/$(WIN32PATH)/tools/media
	cp $(srcdir)/gui/media/detaillogo.jpg  $(srcdir)/$(WIN32PATH)/tools/media/
	cp $(srcdir)/gui/media/logo.jpg        $(srcdir)/$(WIN32PATH)/tools/media/
	cp $(srcdir)/gui/media/tile.gif        $(srcdir)/$(WIN32PATH)/tools/media/
	mv $(srcdir)/$(WIN32PATH)/COPYING      $(srcdir)/$(WIN32PATH)/tools/COPYING.txt
	mv $(srcdir)/$(WIN32PATH)/README       $(srcdir)/$(WIN32PATH)/tools/README.txt
	mv $(srcdir)/$(WIN32PATH)/NEWS         $(srcdir)/$(WIN32PATH)/tools/NEWS.txt

# Special target to create a win32 NSIS installer
win32setup: win32data all
	makensis -V2 -Dtop_srcdir="../.." -Dtext_dir="../../$(WIN32PATH)" -Dbuild_dir="../../$(WIN32PATH)" $(srcdir)/dists/nsis/scummvm-tools.nsi
